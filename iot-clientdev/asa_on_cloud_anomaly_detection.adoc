## 演習: Stream Analyticsでの異常検知


### タスク1: Azure Stream Analyticsの作成

このタスクでは、Azure Stream Analyticsを作成します。

. Azure Portal画面で本演習で利用するリソースグループを表示し、画面上部の[+追加]をクリックします。

. 検索フィールドに "stream analytics" と入力し、リターンを入力します。

. 検索結果の一覧から [Stream Analytics Job] を選択し、[Create]をクリックします。

. パラメータを入力して Stream Analyticsを作成します。
+
.設定値を項目
[cols="2*", options="header"]
|===
|設定項目
|設定値

|Job name
|asa

|Subscription
|本演習で利用するAzureサブスクリプションを選択します

|Resource Group
|例）_iotws_ +
本演習で利用するリソースグループを選択します。

|Location
|東日本

|Hosting environment
|Cloud

|Streaming units
|3 （デフォルト)

|===

. [Create]をクリックします。


### タスク2: Azure Stream Analyticsの入力リソースの設定

本タスクでは、Azure Stream Analyticsのストリームデータの入力ソースを設定します。

. Azure Portal画面で本演習で利用するリソースグループ(例. _iotws_)の中からIoT Hubを選択して概要画面を表示します。

. IoT HubのメニューのSettingsから[Build-in endpoints] を選択します。

. コンシューマーグループの入力フィールドに `asa` と入力し、リターンを入力します。
+
※自動保存が終わるまで待ちます。

. Azure Portal画面で本演習で利用するリソースグループの中からStream Analyticsを選択します。

. Stream AnalyticsのメニューからのJob topologyから[Inputs] を選択します。

. 右側のPaneで[+Add stream input]をクリックし、プルダウンメニューから[IoT Hub]を選択します。

. パラメータを入力して、入力ソースを登録します。
+
.設定値を項目
[cols="2*", options="header"]
|===
|設定項目
|設定値

|Input alias
|iothub +
※この値はStream Analyticsのクエリを記述する際に利用します

|IoT Hubの選択方法
|Select IoT Hub from your subscription

|Subscription
|本演習で利用するAzureサブスクリプションを選択します

|IoT Hub
|例）_iothub1234_ +
本演習で利用するIoT Hubを選択します。

|Endpoints
|Messaging

|Shared access policy name
|iothubowner

|Comsumer group
|asa

|Event serialization format
|JSON

|Encoding
|UTF-8

|Event compression type
|None

|===

. [Save]をクリックします。


### タスク3: Azure Stream Analyticsの出力ソース設定(Blob)

本タスクでは、Azure Stream Analyticsの出力ソースとして Blob Storageを設定します。

. Azure Portal画面で本演習で利用するリソースグループ（例. _iotws_）を選択します。

. 画面上部の[+追加]をクリックします。

. 検索フィールドに `storage account` と入力し、リターンを入力します。

. 検索結果の一覧から[Storage account]を選択して、[Create]をクリックします。

. パラメータを入力して Storage Account を作成します。

. Azure Portal画面で本演習で利用するリソースグループの中から Stream Analyticsを選択します。

. Stream AnalyticsのメニューのJob topologyの中から[Outputs]を選択します。

. 右側のPaneで[+Add]をクリックし、プルダウンメニューから[Blob Storage]を選択します。

. パラメータを入力し、出力リソースを登録します。
+
.設定値を項目
[cols="2*", options="header"]
|===
|設定項目
|設定値

|Output alias
|blob

|Blobストレージの設定方式
|Select Blob storage from your subscriptions

|Subscription
|本演習で利用するAzureサブスクリプションを選択

|Srtorage Account
|本タスクの前半で作成したストレージアカウントを選択

|Container
|Create new

|（コンテナ名）
|rawdata

|Path pattern
|{date} +
※Path patternを指定しないばいな、Blob containerにフラットにファイルが生成されます。

|Date format
|YYYY-MM-DD

|Event serialization fformat
|JSON

|Encoding
|UTF-8

|format
|Line separated

|===

. [Save]をクリックします。

#### タスク4: Blobストレージへの出力
. Azure Stream AnalyticsのメニューのJob topologyの中から[Query]を選択します。

. 右側のPaneでクエリを編集します。
+
```
SELECT
    *
INTO
    blob
FROM
    iothub
```

. [Save]をクリックしてクエリを保存します。

. Stream Analyticsのメニューの[Overview]をクリックします。

.  右側のPaneから[> Start]をクリックし、表示されたダイアログでJob output start timeが[Now]になっていることを確認し、[Start]をクリックします。

. Azure Portal画面で本演習で利用するIoT Deviceの仮想マシンを選択し、右側のPaneの[Connect]をクリックします。

. 表示されたダイアログで[SSH]のタブを選択し、SSHのログインコマンドをコピーします。

. Azure Portalのクラウドシェルを起動し、SSHのログインコマンドをペースとして、IoT Deviceの仮想マシンにSSHでログインします。

. IoTデバイスのサンプルアプリケーションを実行します。
+
```
cd azure-iot-samples-python-master/iot-hub/Quickstarts/simulated-device-2

python SimulatedDevice.py
```

. Azureポータル画面で本演習で利用するStorage Accountを選択します。

. 右側のPaneで[Blob]をクリックします。

. 表示された一覧の[rawdata]->[日付フォルダー]->[ファイル名]をクリックします。

. 画面上部の[Edit blob]をクリックしてファイルにテレメトリデータが出力されていることを確認します。

. Azure Portal画面で本演習で利用するAzure Stream Analyticsを選択し、右側のPaneで[Stop]をクリックします。



### タスク5: Stream Analyticsの出力ソースの設定(Azure Function)

本タスクでは、Azure Stream Analyticsの出力ソースを設定します。

. Azure Portal画面で本演習で利用するリソースグループの中からStream Analyticsを選択します。

. Stream AnalyticsのメニューのJob topologyから[Outputs] を選択します。

. 右側のPaneで[+Add]をクリックし、プルダウンメニューから[Azure Function]を選択します。

. パラメータを入力して、入力ソースを登録します。
+
.設定値を項目
[cols="2*", options="header"]
|===
|設定項目
|設定値

|Output alias
|slack

|IoT Hubの選択方法
|Select IoT Hub from your subscription

|Subscription
|本演習で利用するAzureサブスクリプションを選択します

|Functio app
|例）_slackfunc1234_ +
Slackにメッセージを送信するFunctionを選択します

|Function
|HttpTriggerSlack

|Max Batch Size
|（空白）

|Max barch count
|（空白）

|===
+
[Save]をクリックします。

### タスク6: Azure Functionへの出力

本タスクでは、Azure Stream Analytisの異常検知の組み込み関数を利用し、突発的な値の変化があった時に、Slackにメッセージを送信する設定をします。

. Azureポータル画面で本演習で利用するAzure Stream Analyticsを選択します。

. Azure Stream AnalyticsのメニューのJob topologyの[Query]をクリックします。

. 右側のPaneでクエリを編集し、先ほどのクエリの先頭に次のクエリを付け足します。
+
```
WITH
AnomalyDetectionStep AS
(
    SELECT
        EVENTENQUEUEDUTCTIME AS time,
        CAST(temperature AS float) AS temp,
        AnomalyDetection_SpikeAndDip(CAST(temperature AS float), 95, 120, 'spikesanddips')
            OVER(LIMIT DURATION(second, 120)) AS SpikeAndDipScores
    FROM iothub
),
AnomalyDetectionStepResult AS
(
    SELECT
        time,
        temp,
        CAST(GetRecordPropertyValue(SpikeAndDipScores, 'Score') AS float) AS
        SpikeAndDipScore,
        CAST(GetRecordPropertyValue(SpikeAndDipScores, 'IsAnomaly') AS bigint) AS
        IsSpikeAndDipAnomaly
    FROM
        AnomalyDetectionStep
)
SELECT
        time,
        temp,
        SpikeAndDipScore,
        IsSpikeAndDipAnomaly
INTO
    slackfunc
FROM
    AnomalyDetectionStepResult
WHERE
    IsSpikeAndDipAnomaly = 1

SELECT
  *
INTO
  blob
FROM
  iothub
```

[NOTE]
====
**WITH句**

クエリの結果を一時的に名前付きのオブジェクトとして保持します。

```
WITH [結果セット名] AS [クエリ]
```

**AnomalyDetection_SpikeAndDip関数**

値の急上昇と急降下を検出し、異常の有無のスコアを返します。


```
AnomaryDetection_SpikeAndDip([値], [信頼度], [履歴サイズ],[モード])
```

[cols="2*", options="header"]
|===
|パラメータ
|説明

|値
|異常検知の対象となる値

|期待値
|検証結果の信頼度を1〜100の間で指定。信頼度が低いほど検知される可能性が高くなる。

|履歴サイズ
|モデルの学習に利用するイベントの数　+

|モード
|モードは3種類{spikesanddips, spikes, dips} +
モードの指定により、Spikes（急上昇)、Dips(急降下)の両方またはいずれかを検知。

|===

[cols="2*", options="header"]
|===
|返り値
|説明

|IsAnomaly
|異常の有無を0か1で返します +
0 : 異常あり +
1 : 異常なし

|Score
|異常が発生している可能性の指標。低い値の場合、可能性が低いことを意味する

|===


====

## タスク7: テレメトリデータの処理

このタスクでは、IoT Deviceから送信されたテレメトリデータをStream Analyticsでクエリ処理し、温度の急上昇、急降下があった場合にSlackにメッセージが送信されていることを確認します。

. Azure Portal画面で本演習で利用するStream Analyticsを選択します。
+
* 左側のメニューで[Resource groups]をクリック
* リソースグループ一覧でリソースグループ（例. _iotws_）をクリック
* 一覧からStream Analytics(例. _asa_)をクリック

. 画面上部の[>Start]をクリックして、ストリーミング処理を開始します。

. Azure Portal画面で本演習で利用するIoT Device用の仮想マシンを選択します。
+
* 左側のメニューで[Resource groups]をクリック
* リソースグループ一覧でリソースグループ（例. _iotws_）をクリック
* 一覧からIoT Device用の仮想まちんをクリック

. 右側のPane上部の[Connect]をクリックしてダイアログを表示し、SSHコマンドの文字列をコピーします。

. Azure Portal画面上部の[>_]をクリックし、Cloud Shellを実行します。

. Cloud ShellのターミナルにSSHコマンドをペースとし、IoT DeviceにSSHでログインします。

. IoT Deviceのサンプルプルグラムのディレクトリに移動し、プログラムを実行します。
+
```
cd iotdevice_python/iot-hub/Quickstarts/simulated-device-2

python SimulatedDevice.py
```

. WebブラウザーでSlackのワークスペースを開き、温度異常のメッセージを確認します。
