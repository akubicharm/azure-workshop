link:agenda.adoc[目次]

## 演習 : メトリクスの収集とアラート

Azure IoT Hubのメトリックの可視化と、メトリクスに基づくアラートを設定していきます。


### タスク 1: メトリックの可視化

. Azureポータル画面で本演習で利用する IoT Hub（例. _iothub1234_）を選択します。

. IoT Hubの設定画面の左Paneの監視セクションの[メトリック]をクリックします。

. 右Paneの上部にある[過去24時間]をクリックして、プルダウンメニューで時間の範囲を変更します。
+
.設定項目と設定値
[cols="2*", options="header"]
|===
|設定項目
|設定値

|時間の範囲
|過去4時間

|時間の粒度
|1分
|===

. [適用]をクリックします。

. 右Paneの楕円の枠で囲まれたプルダウンメニューで[メトリック]と[集計]を選択します。
+
.設定項目と設定値
[cols="2*", options="header"]
|===
|設定項目
|設定値

|メトリック
|Telemetry messages sent （送信済みテレメトリメッセージ）

|集計
|合計
|===

. 右Pane上部のグレーの矩形の中から[メトリックの追加]をクリックします。

. 先ほどと同様に、[メトリック]と[集計]を選択します。
+
.設定項目と設定値
[cols="2*", options="header"]
|===
|設定項目
|設定値

|メトリック
|Telemetry messages sent （送信済みテレメトリメッセージ）

|集計
|合計
|===

. 右Pane上部のグレーの矩形の中から[ダッシュボードにピン留]をクリックします。


### タスク2: アラートの設定

. Azureポータル画面の左Paneで[モニター]をクリックします。

. モニターの設定画面の左Paneで[アラート]をクリックします。

. モニターの設定画面の右Pane上部の[+新しいアラートルール]をクリックして、アラートルールの作成を開始します。

. ルールの作成画面のリソースエリアのリソース[選択]をクリックします。

. リソースの選択のダイアログで、フィルターの条件を設定して対象リソースを絞ります。
+
.設定項目と設定値
[cols="2*", options="header"]
|===
|設定項目
|設定値

|サブスクリプション別でフィルター
|本演習で利用するサブスクリプション

|リソースの種類でフィルター
|IoT Hub
|===

. 表示されたリソースの一覧から、本演習で利用するIoT Hub(ex. _iothub1234_)を選択し、下部の[完了]をクリックします。

. ルールの作成画面の条件エリアの[追加]をクリックします。

.. シグナルロジックの構成画面で、シグナル萌衣の一覧から[Telemetry messages sent]をクリックします。

.. アラートの設定をします。
+
.設定項目と設定値
[cols="2*", options="header"]
|===
|設定項目
|設定値

2+|**アラートロジック**

|しきい値
|Static

|演算子
|次の値より大きい

|集計の種類
|合計

|しきい値
|50

2+|**評価基準**

|集約粒度(期間)
|5分

|評価頻度
|1分ごと
|===

.. 画面下部の[完了]をクリックします。

. ルールの作成画面のアクションエリアの[アクショングループの作成]をクリックします。

.. アクショングループの追加画面で値を設定します。
+
.設定項目と設定値
[cols="2*", options="header"]
|===
|設定項目
|設定値

|アクショングループ名
|任意のグループ名 +
例）_IoTAlertGroup_


|短い名前
|任意の文字列　+
例）_iot_

|サブスクリプション
|本演習で利用するサブスクリプション

|リソースグループ
|本演習で利用するリソースグループ

|アクション名
|任意のアクション名 +
例）Email

|アクションタイプ
|電子メール/SMS/プッシュ/音声

|===

.. 電子メール/SMS/プッシュ/音声のダイアログで電子メールのチェックボックスをチェックしてメールアドレスを入力し、[OK]をクリックします。

.. アクショングループの追加画面下部の[OK]をクリックします。

. ルールの作成画面に戻ってアラート詳細を設定します。
+
.設定項目と設定値
[cols="2*", options="header"]
|===
|設定項目
|設定値

|アラートルール名
|任意のルール名

|説明
|任意のメッセージ（この内容が電子メールに記載されます）

|重要度
|重要度3

|ルールの作成時に有効にする
|はい

|===

. 画面下部の[アラートルールの作成]をクリックします。

. E-Mailを確認し Azure Monitor のアクショングループへの登録通知のメッセージが届いていることを確認します。
+
From のアドレスは "Microsoft Azure <azure-noreply@microsoft.com>" です。



タスク3: メトリックとアラートの確認

. 本演習で利用するIoTデバイス用の仮想マシンにSSHでログインします。

. サンプルプログラムのディレクトリに移動します
+
```
cd ~/azure-iot-samples-python/iot-hub/Quickstarts/simulated-device-2
```

. サンプルプログラムを実行します。
+
```
python SimulatedDevice.py
```
. E-Mailを確認し、Azure Monitorのアラートメッセージが送られていることを確認します。

. Azure管理画面の左Paneで[モニター]をクリックし、Azure Monitorの画面を表示します。

. Azure Monitor画面の左Paneで[アラート]をクリックします。

. _Sev 3_ のアラートをクリックしてアラートの詳細を表示します。

. サンプルプログラムを停止してしばらく待ちます。

. アラートのモニター状態が *Resolved* になったことを確認します。

link:agenda.adoc[目次]
